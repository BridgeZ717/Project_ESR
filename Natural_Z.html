<!DOCTYPE html>
<html>

<head>
    <title>Natural Z</title>
    <!-- Chart JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
</head>

<body>
    <div class="topnav">
        <a href="Natural_X.html">X Chart</a>
        <a href="Natural_Y.html">Y Chart</a>
        <a class="active" href="Natural_Z.html">Z Chart</a>
        <a href="merge.html">Merge Chart</a>
    </div>
    <div>
        <canvas id="SampleChart"></canvas>
        <p>Start from</p>
        <input type="text" id="start" value="900">
        <p>to</p>
        <input type="text" id="end" value="1250">
        <p>Align from</p>
        <input type="text" id="alignStart" value="900">
        <p>to</p>
        <input type="text" id="alignEnd" value="960">
        <button onclick="creatChart()">Show Chart</button>
    </div>
    <canvas id="myChart"></canvas>
    <div id="minmax"></div>
    <a href="javascript:void(0);" id="store">Calculate and store Average</a>
    <script>
        if (localStorage.getItem("storageName") == 'null') {
            var fileName = prompt("Please put all your data into 'data' folder. And then please input your data set name. For example if your file is 'BF_ESR_06_360s_X_gon_0dg_result.csv' then you should input 'BF_ESR_06_360s'");
            localStorage.setItem("storageName", fileName);
        } else {
            var fileName = localStorage.getItem("storageName");
        }
        var degree = 0;
        const xlabels = [];
        var xlabelsFlag = 0; //check is there any X labels in the chart
        const dg0 = [];
        const dg20 = [];
        const dg40 = [];
        const dg60 = [];
        const dg80 = [];
        const dg100 = [];
        const dg120 = [];
        const dg140 = [];
        const dg160 = [];
        const dg180 = [];
        const aveArr = [];
        //creatChart();

        const sampleXlabels = [];
        var sampleXlabelsFlag = 0;
        const sampleDg0 = [];
        const sampleDg20 = [];
        creatSampleChart();
        async function getSampleData(file,sampleDg) {
            //get sample data start
            const response = await fetch(file);
            const data = await response.text();
            var count = 1;
            const rows = data.split('\n').slice(51); //each line becomes to a variable, slice(51) -> ignore index 0(title) start from index 51
            rows.forEach(elt => {
                const row = elt.split(';');
                const mt = row[1];
                sampleDg.push(mt);
                if(sampleXlabelsFlag == 0)
                {sampleXlabels.push(count);
                count++}
            });
            //get sample data finished
        }
        async function creatSampleChart() {
            await getSampleData('./data/'+fileName+'_Z_gon_0dg_result.csv',sampleDg0)
            sampleXlabelsFlag = 1;
            await getSampleData('./data/'+fileName+'_Z_gon_20dg_result.csv',sampleDg20)
            //create chart start
            const ctx = document.getElementById('SampleChart').getContext('2d');
            const chart = new Chart(ctx, {
                // The type of chart we want to create
                type: 'line',
                // The data for our dataset
                data: {
                    labels: sampleXlabels,
                    datasets: [{
                        label: '0dg ref',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        borderColor: 'rgb(0, 0, 255)',
                        data: sampleDg0
                    },{
                        label: '20dg ref',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        borderColor: 'rgb(255, 0, 0)',
                        data: sampleDg20
                    }]
                },
                // Configuration options go here
                options: {}
            });

        }

        async function creatChart() {
            xlabelsFlag = 0;
            degree = 0;
            document.getElementById("minmax").innerHTML += '<table class="table"><thead><tr><th scope="col">dg</th><th scope="col">Max</th></tr></thead><tbody id="tableContent"></tbody></table>';
            await getData('./data/'+fileName+'_Z_gon_0dg_result.csv', dg0);
            xlabelsFlag = 1;
            await getData('./data/'+fileName+'_Z_gon_20dg_result.csv', dg20);
            await getData('./data/'+fileName+'_Z_gon_40dg_result.csv', dg40);
            await getData('./data/'+fileName+'_Z_gon_60dg_result.csv', dg60);
            await getData('./data/'+fileName+'_Z_gon_80dg_result.csv', dg80);
            await getData('./data/'+fileName+'_Z_gon_100dg_result.csv', dg100);
            await getData('./data/'+fileName+'_Z_gon_120dg_result.csv', dg120);
            await getData('./data/'+fileName+'_Z_gon_140dg_result.csv', dg140);
            await getData('./data/'+fileName+'_Z_gon_160dg_result.csv', dg160);
            await getData('./data/'+fileName+'_Z_gon_180dg_result.csv', dg180);
                       //auto save start
                       average(aveArr, dg0, dg20, dg40, dg60, dg80, dg100, dg120, dg140, dg160, dg180);
            sessionStorage.setItem('zAveArr', aveArr);
            //auto save end
            const ctx = document.getElementById('myChart').getContext('2d');
            const chart = new Chart(ctx, {
                // The type of chart we want to create
                type: 'line',
                // The data for our dataset
                data: {
                    labels: xlabels,
                    datasets: [{
                        label: '0dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderWidth: 2,
                        borderColor: 'rgb(255, 0, 0)',
                        data: dg0
                    }, {
                        label: '20dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(58, 120, 187)',
                        borderWidth: 2,
                        data: dg20
                    }, {
                        label: '40dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(82, 132, 181)',
                        borderWidth: 2,
                        data: dg40
                    }, {
                        label: '60dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(101, 144, 175)',
                        borderWidth: 2,
                        data: dg60
                    }, {
                        label: '80dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(116, 157, 169)',
                        borderWidth: 2,
                        data: dg80
                    }, {
                        label: '100dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(129, 170, 163)',
                        borderWidth: 2,
                        data: dg100
                    }, {
                        label: '120dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(141, 183, 156)',
                        borderWidth: 2,
                        data: dg120
                    }, {
                        label: '140dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(151, 196, 148)',
                        borderWidth: 2,
                        data: dg140
                    }, {
                        label: '160dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(161, 210, 141)',
                        borderWidth: 2,
                        data: dg160
                    }, {
                        label: '180dg',
                        fill: false,
                        //backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(171, 223, 132)',
                        borderWidth: 2,
                        data: dg180
                    }]
                },

                // Configuration options go here
                options: {}
            });
        }

        async function getData(file, dg) {
            var startIndex = parseInt(document.getElementById("start").value) + 51; //value start from 51
            var endIndex = parseInt(document.getElementById("end").value) + 51;

            const response = await fetch(file);//get file
            const data = await response.text();//change file content to text
            var arr = [];
            const rows = data.split('\n').slice(startIndex, endIndex); //each line becomes to a variable, slice(51) -> ignore index 0(title) start from index 51
            rows.forEach(elt => {
                const row = elt.split(';');
                const mt = row[1];
                arr.push(mt);
            });
            var min = Math.min.apply(this, arr),
                max = Math.max.apply(this, arr),
                index;
            var alignStart = parseInt(document.getElementById("alignStart").value) + 51 - startIndex;
            var alignEnd = parseInt(document.getElementById("alignEnd").value) + 51 - startIndex;

            var tempMax = rangeMax(arr, alignStart, alignEnd);

            //****Very Strange probelms down here. I tired to use indexOf but not working so I wrote this function↓
            function rangeMax(arr, alignStart, alignEnd) {
                const tempArr = [];
              
                for (alignStart; alignStart <= alignEnd; alignStart++) {
                    tempArr.push(arr[alignStart]);
                }
               
                return Math.max.apply(this, tempArr);
            }
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] == tempMax) {
                    index = i;//finde the tempMax to align the data
                }
            }
            //push data 
            for (var i = 0; i < endIndex - startIndex; i++) {
                dg.push(arr[index]);
                index++;
                if (xlabelsFlag == 0)
                    xlabels.push(i);
            }
            //create table
            document.getElementById("tableContent").innerHTML += '<tr><th scope="row">' + degree + '</th><td>' + max + '</td></tr>';
            degree += 20;
        }
        function average(arr, dg0, dg20, dg40, dg60, dg80, dg100, dg120, dg140, dg160, dg180) {
            for (var i = 0; i < dg0.length; i++) {
                const ave = ((+dg0[i]) + (+dg20[i]) + (+dg40[i]) + (+dg60[i]) + (+dg80[i]) + (+dg100[i]) + (+dg120[i]) + (+dg140[i]) + (+dg160[i]) + (+dg180[i])) / 10
                arr.push(ave);
            }
        }



        $('#store').on('click', function () {
            average(aveArr, dg0, dg20, dg40, dg60, dg80, dg100, dg120, dg140, dg160, dg180);
            sessionStorage.setItem('zAveArr', aveArr);
        });


    </script>



</body>

</html>